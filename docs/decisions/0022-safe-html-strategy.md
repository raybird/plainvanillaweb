# ADR 0022: 自動轉義與受信任 HTML 策略 (Auto-escaping & Trusted HTML Strategy)

## 上下文
在無框架開發中，直接使用 `innerHTML` 渲染模板容易導致 XSS (Cross-Site Scripting) 攻擊。原本的 `html` 標籤模板缺乏自動轉義機制，導致開發者必須手動呼叫 `escapeHTML`，不僅繁瑣且容易遺漏。此外，過度轉義會導致合法的 HTML 片段（如巢狀模板）無法正確渲染。

## 決策
引入 **`SafeHTML`** 機制來平衡安全性與靈活性：
1.  **自動轉義**: `html` 標籤模板現在會自動轉義所有插值變數（Interpolations），確保預設情況下是安全的。
2.  **受信任內容 (SafeHTML)**: 建立 `SafeHTML` 類別。`html` 模板的回傳值以及由 `unsafe()` 標記的字串將被視為「受信任內容」，不再進行轉義。
3.  **嵌套支援**: `html` 模板能辨識並遞歸處理嵌套的 `SafeHTML` 物件或陣列，支援複雜組件的宣告式渲染。
4.  **基類適配**: 更新 `BaseComponent`，確保其 `update()` 方法能正確處理 `SafeHTML` 物件並渲染為字串。

## 後果
- **優點**: 顯著降低 XSS 風險，開發者無需再手動轉義。
- **優點**: 代碼更簡潔，模板插值更具直覺性。
- **優點**: 具備教育意義，展示了現代框架（如 React/Lit）底層的安全處理邏輯。
- **缺點**: 在需要動態渲染外部 HTML 片段時，必須明確呼叫 `unsafe()`，這增加了意識負擔，但這正是為了安全性。
