# ADR 0058: 解決 Service Worker 更新通知在多分頁環境下的重複顯示問題

## 狀態
已接受 (Accepted)

## 背景
使用者回報在 `plainvanillaweb` 開啟多個分頁的情況下，切換分頁時會重複收到「應用程式有新版本」的通知。這是因為每個分頁的 Service Worker 註冊對象都會獨立觸發 `updatefound` 事件，導致通知在每個分頁中重複發送。

## 決策
實作「雙層過濾機制」來確保通知的唯一性與低干擾性：

1.  **服務層過濾 (Service Level)**：在 `NotificationService` 中加入去重邏輯。若目前頁面已顯示完全相同的訊息（message 與 type 皆相同），則不再重複新增。這防止了單一頁面因重複事件而產生通知堆疊。
2.  **全域跨分頁防抖 (Global Debounce)**：在 `index.js` 的 SW 註冊邏輯中，利用 `localStorage` 紀錄最後一次通知的時間戳記 (`sw-update-notified-at`)。僅在距離上次通知超過 10 秒時，才允許發送新的更新提示。這有效地協調了多個分頁之間的通知行為。

## 後果
- **優點**：大幅提升使用者體驗，解決分頁切換時的視覺干擾。維持了 PWA 更新通知的專業感。
- **缺點**：如果使用者在 10 秒內迅速關閉了顯示通知的分頁並切換到另一個分頁，可能會錯過該次通知（但 SW 通常會維持在已安裝狀態，下次觸發更新檢查時仍會再次提示）。
