# ADR 0071: 引入原生 Web Locks API 併發協調

## 狀態

Accepted

## 背景

專案近期在媒體與掃碼流程修正了啟動/恢復競態，顯示出多流程爭用同一資源時，僅靠局部旗標仍容易在跨事件、跨任務情境出現重入風險。為了建立可重用且教學化的併發協調模式，需要導入原生鎖機制。

## 決策

導入 `Web Locks API` 作為 Lab 新項目，並採用雙策略教學：

1. 以 `exclusive` 展示「可等待」的互斥任務，確保共享資源一次只被一個流程操作。
2. 以 `ifAvailable` 展示「不可等待」的非阻塞任務，忙碌時直接略過避免堆積。
3. 在 `#/lab/weblocks` 提供可視化執行歷程，對照取得鎖、略過與完成次數。
4. 不支援環境顯示降級提示，維持頁面可讀與可操作。

## 後果

- **優點**：建立可移植的原生併發控制模式，可套用於媒體恢復、離線同步、背景索引等場景。
- **優點**：維持零第三方依賴，符合 Vanilla-first。
- **缺點**：API 支援度非全瀏覽器一致，仍需保留降級策略。
